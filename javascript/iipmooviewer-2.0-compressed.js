var IIP=new Class({getMetaDataURL:function(b){return"FIF="+b+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number"},getTileURL:function(b,a,c,d,e,f){return b+"?FIF="+a+"&CNT="+e+"&SDS="+d+"&JTL="+c+","+f},parseMetaData:function(b){var a=b.split("Max-size");a[1]||alert("Error: Unexpected response from server "+this.server);a=a[1].split(" ");var c={w:parseInt(a[0].substring(1,a[0].length)),h:parseInt(a[1])};a=b.split("Tile-size");a=a[1].split(" ");var d={w:parseInt(a[0].substring(1,a[0].length)),
h:parseInt(a[1])};a=b.split("Resolution-number");num_resolutions=parseInt(a[1].substring(1,a[1].length));return{max_size:c,tileSize:d,num_resolutions:num_resolutions}},getRegionURL:function(b,a,c,d,e){return"?FIF="+b+"&WID="+d+"&RGN="+(a+","+c+","+d+","+e)+"&CVT=jpeg"}}),Zoomify=new Class({getMetaDataURL:function(b){return"Zoomify="+b+"/ImageProperties.xml"},getTileURL:function(b,a,c,d,e,f,g,h){return b+"?Zoomify="+a+"/TileGroup0/"+c+"-"+g+"-"+h+".jpg"},parseMetaData:function(b){var a=b.split('"');
b=parseInt(a[1]);var c=parseInt(a[3]);a=parseInt(a[11]);for(var d=b>c?b:c,e=1;d>a;){d=Math.floor(d/2);e++}return{max_size:{w:b,h:c},tileSize:{w:a,h:a},num_resolutions:e}},getRegionURL:function(){return null}}),Djatoka=new Class({svc_val_fmt:"info:ofi/fmt:kev:mtx:jpeg2000",svc_id:"info:lanl-repo/svc/getRegion",getMetaDataURL:function(b){return"url_ver=Z39.88-2004&rft_id="+b+"&svc_id=info:lanl-repo/svc/getMetadata"},getTileURL:function(b,a,c){return b+"?url_ver=Z39.88-2004&rft_id="+a+"&svc_id="+this.svc_id+
"&svc_val_fmt="+this.svc_val_fmt+"&svc.format=image/jpeg&svc.level="+c+"&svc.rotate=0&svc.region="+djatoka_y+","+djatoka_x+",256,256"},parseMetaData:function(b){var a=eval("("+b+")");b=parseInt(a.width);var c=parseInt(a.height);a=parseInt(a.levels);return{max_size:{w:b,h:c},tileSize:{w:256,h:256},num_resolutions:a}},getRegionURL:function(){return null}}),DeepZoom=new Class({getMetaDataURL:function(b){return"Deepzoom="+b+".dzi"},getTileURL:function(b,a,c,d,e,f,g,h){return b+"?DeepZoom="+a+"_files/"+
(c+1)+"/"+g+"_"+h+".jpg"},parseMetaData:function(b){var a=parseInt(/TileSize="(\d+)/.exec(b)[1]),c=parseInt(/Width="(\d+)/.exec(b)[1]);b=parseInt(/Height="(\d+)/.exec(b)[1]);return{max_size:{w:c,h:b},tileSize:{w:a,h:a},num_resolutions:Math.ceil(Math.log(c>b?c:b)/Math.LN2)}},getRegionURL:function(){return null}});var IIPMooViewer=new Class({version:"2.0",initialize:function(b,a){this.source=b||alert("No element ID given to IIPMooViewer constructor");this.server=a.server||"/fcgi-bin/iipsrv.fcgi";this.render=a.render||"spiral";this.images=Array(a.image.length);a.image||alert("Image location not set in class constructor options");if(typeOf(a.image)=="array")for(i=0;i<a.image.length;i++)this.images[i]={src:a.image[i],sds:"0,90",cnt:1};else this.images=[{src:a.image,sds:"0,90",cnt:1}];this.loadoptions=a.load||
null;this.credit=a.credit||null;this.scale=a.scale||null;this.viewport=null;if(a.viewport)this.viewport={resolution:typeof a.viewport.resolution=="undefined"?null:parseInt(a.viewport.resolution),x:typeof a.viewport.x=="undefined"?null:parseFloat(a.viewport.x),y:typeof a.viewport.y=="undefined"?null:parseFloat(a.viewport.y)};this.enableFullscreen=a.enableFullscreen==false?false:true;this.disableContextMenu=true;this.showNavWindow=a.showNavWindow==false?false:true;this.showNavButtons=a.showNavButtons==
false?false:true;this.navWinSize=a.navWinSize||0.2;this.winResize=a.winResize==false?false:true;this.prefix=a.prefix||"images/";switch(a.protocol){case "zoomify":this.protocol=new Zoomify;break;case "deepzoom":this.protocol=new DeepZoom;break;case "djatoka":this.protocol=new Djatoka;break;default:this.protocol=new IIP}this.effects=this.preload=false;this.annotations=a.annotations||null;this.annotationTip=null;this.annotationsVisible=true;this.targetclick=a.targetclick||null;this.max_size={};this.navWin=
{w:0,h:0};this.num_resolutions=this.hei=this.wid=this.opacity=0;this.view={x:0,y:0,w:this.wid,h:this.hei,res:0,orientation:0};this.navpos={};this.tileSize={};this.tiles=[];this.nTilesToLoad=this.nTilesLoaded=0;this.fullscreen=this.locked=false;this.CSSprefix="";if(Browser.firefox)this.CSSprefix="-moz-";else if(Browser.chrome||Browser.safari||Browser.Platform.ios)this.CSSprefix="-webkit-";else if(Browser.opera)this.CSSprefix="-o-";else if(Browser.ie)this.CSSprefix="ms-";window.addEvent("domready",
this.load.bind(this))},requestImages:function(){if(this.view.orientation!=0){this.view.orientation=0;this.canvas.setStyle(this.CSSprefix+"transform","rotate(0deg)")}this.canvas.setStyle("cursor","wait");this.annotationTip&&this.annotationTip.detach(this.canvas.getChildren("div.annotation"));this.canvas.getChildren("div.annotation").each(function(b){b.eliminate("tip:text");b.destroy()});this.loadGrid();this.createAnnotations();this.annotationTip&&this.annotationTip.attach(this.canvas.getChildren("div.annotation"))},
loadGrid:function(){if(!this.locked){this.locked=true;var b=this.preload?1:0,a=Math.floor(this.view.x/this.tileSize.w)-b,c=Math.floor(this.view.y/this.tileSize.h)-b;if(a<0)a=0;if(c<0)c=0;var d=this.view.w;if(this.wid<this.view.w)d=this.wid;var e=Math.ceil((d+this.view.x)/this.tileSize.w-1)+b;d=this.view.h;if(this.hei<this.view.h)d=this.hei;d=Math.ceil((d+this.view.y)/this.tileSize.h-1)+b;b=Math.ceil(this.wid/this.tileSize.h);var f=Math.ceil(this.hei/this.tileSize.h);if(e>=b)e=b-1;if(d>=f)d=f-1;f=
Math.floor(this.view.x%this.tileSize.w);if(this.wid<this.view.w)f-=(this.view.w-this.wid)/2;f=Math.floor(this.view.y%this.tileSize.h);if(this.hei<this.view.h)f-=(this.view.h-this.hei)/2;var g,h;h=f=0;var o=a+Math.round((e-a)/2),p=c+Math.round((d-c)/2),l=Array((e-a)*(e-a)),n=Array((e-a)*(e-a));n.empty();var m=0;for(g=c;g<=d;g++)for(c=a;c<=e;c++){l[m]={};l[m].n=this.render=="spiral"?Math.abs(p-g)*Math.abs(p-g)+Math.abs(o-c)*Math.abs(o-c):Math.random();l[m].x=c;l[m].y=g;m++;f=c+g*b;n.push(f)}this.nTilesLoaded=
0;this.nTilesToLoad=m*this.images.length;var q=this;this.canvas.getChildren("img").each(function(j){var k=parseInt(j.retrieve("tile"));if(!n.contains(k)){j.destroy();q.tiles.erase(k)}});l.sort(function(j,k){return j.n-k.n});for(e=0;e<m;e++){c=l[e].x;g=l[e].y;f=c+g*b;if(this.tiles.contains(f)){this.nTilesLoaded++;this.showNavWindow&&this.refreshLoadBar();this.nTilesLoaded>=this.nTilesToLoad&&this.canvas.setStyle("cursor","move")}else for(h=0;h<this.images.length;h++){a=new Element("img",{"class":"layer"+
h,styles:{left:c*this.tileSize.w,top:g*this.tileSize.h}});this.effects&&a.setStyle("opacity",0.1);a.inject(this.canvas);d=this.protocol.getTileURL(this.server,this.images[h].src,this.view.res,this.images[h].sds,this.images[h].cnt,f,c,g);a.addEvents({load:function(j){var k=j[0];j=j[1];this.effects&&k.setStyle("opacity",1);if(k.width&&k.height){this.nTilesLoaded++;this.showNavWindow&&this.refreshLoadBar();this.nTilesLoaded>=this.nTilesToLoad&&this.canvas.setStyle("cursor","move");this.tiles.push(j)}else k.fireEvent("error")}.bind(this,
[a,f]),error:function(){this.removeEvents("error");this.set("src",this.src+"?"+Date.now())}});a.set("src",d);a.store("tile",f)}}this.images.length>1&&this.canvas.getChildren("img.layer"+(h-1)).set("opacity",this.opacity);this.locked=false}},getRegionURL:function(){var b=this.resolutions[this.view.res].w,a=this.resolutions[this.view.res].h;return this.server+this.protocol.getRegionURL(this.images[0].src,this.view.x/b,this.view.y/a,this.view.w/b,this.view.h/a)},key:function(b){var a=new DOMEvent(b),
c=Math.round(this.view.w/4);switch(b.code){case 37:this.nudge(-c,0);IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.nudge(-c,0)});a.preventDefault();break;case 38:this.nudge(0,-c);IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.nudge(0,-c)});a.preventDefault();break;case 39:this.nudge(c,0);IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.nudge(c,0)});a.preventDefault();break;case 40:this.nudge(0,c);IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.nudge(0,
c)});a.preventDefault();break;case 107:if(!b.control){this.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.zoomIn()});a.preventDefault()}break;case 109:if(!b.control){this.zoomOut();IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(e){e.zoomOut()})}break;case 189:b.control||this.zoomOut();break;case 72:this.toggleNavigationWindow();break;case 82:if(!b.control){if(b.shift)this.view.orientation-=45;else this.view.orientation+=45;this.rotate(this.view.orientation);
if(IIPMooViewer.sync){var d=this.view.orientation;IIPMooViewer.windows(this).each(function(e){e.rotate(d)})}}break;case 65:this.annotations&&this.toggleAnnotations();break;case 27:if(this.fullscreen)IIPMooViewer.sync||this.toggleFullScreen();document.id(this.source).getElement("div.info").fade("out");break;case 70:IIPMooViewer.sync||this.toggleFullScreen()}},rotate:function(b){if(!Browser.buggy){this.canvas.getPosition();b="rotate("+b+"deg)";this.canvas.setStyle(this.CSSprefix+"transform-origin",
(this.wid>this.view.w?Math.round(this.view.x+this.view.w/2):Math.round(this.wid/2))+"px "+((this.hei>this.view.h?Math.round(this.view.y+this.view.h/2):Math.round(this.hei/2))+"px"));this.canvas.setStyle(this.CSSprefix+"transform",b)}},toggleFullScreen:function(){var b,a,c,d;if(this.enableFullscreen){if(this.fullscreen){b=this.targetsize.pos.x;a=this.targetsize.pos.y;c=this.targetsize.size.x;d=this.targetsize.size.y}else{this.targetsize={pos:document.id(this.source).getPosition(),size:document.id(this.source).getSize()};
a=b=0;d=c="100%"}document.id(this.source).setStyles({left:b,top:a,width:c,height:d});(this.fullscreen=!this.fullscreen)&&this.showPopUp(IIPMooViewer.lang.fullscreen);this.reload()}},toggleNavigationWindow:function(){document.id(this.source).getElement("div.navcontainer")&&document.id(this.source).getElement("div.navcontainer").get("reveal").toggle()},showPopUp:function(b){var a=(new Element("div",{"class":"message",html:b})).inject(document.id(this.source));(Browser.buggy?function(){a.destroy()}:
function(){a.fade("out").get("tween").chain(function(){a.destroy()})}).delay(3E3)},scrollNavigation:function(b){var a=0,c=0,d=this.zone.getSize(),e=d.x;d=d.y;if(b.event){b.stop();var f=this.zone.getParent().getPosition();a=b.event.clientX-f.x-e/2;c=b.event.clientY-f.y-d/2}else{a=b.offsetLeft;c=b.offsetTop-10;if(Math.abs(a-this.navpos.x)<3&&Math.abs(c-this.navpos.y)<3)return}if(a>this.navWin.w-e)a=this.navWin.w-e;if(c>this.navWin.h-d)c=this.navWin.h-d;if(a<0)a=0;if(c<0)c=0;a=Math.round(a*this.wid/
this.navWin.w);c=Math.round(c*this.hei/this.navWin.h);(e=Math.abs(a-this.view.x)<this.view.w/2&&Math.abs(c-this.view.y)<this.view.h/2)?this.canvas.morph({left:this.wid>this.view.w?-a:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-c:Math.round((this.view.h-this.hei)/2)}):this.canvas.setStyles({left:this.wid>this.view.w?-a:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-c:Math.round((this.view.h-this.hei)/2)});this.view.orientation=0;this.canvas.setStyle(this.CSSprefix+
"transform","rotate(0deg)");this.zone.setStyle(this.CSSprefix+"transform","rotate(0deg)");this.view.x=a;this.view.y=c;e||this.requestImages();b.event&&this.positionZone();IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(g){g.moveTo(a,c)})},scroll:function(){var b=this.canvas.getPosition(this.source);b.x=this.canvas.getStyle("left").toInt();b.y=this.canvas.getStyle("top").toInt();var a=-b.x,c=-b.y;this.moveTo(a,c);IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(d){d.moveTo(a,
c)})},checkBounds:function(b,a){if(b>this.wid-this.view.w)b=this.wid-this.view.w;if(a>this.hei-this.view.h)a=this.hei-this.view.h;if(b<0||this.wid<this.view.w)b=0;if(a<0||this.hei<this.view.h)a=0;this.view.x=b;this.view.y=a},moveTo:function(b,a){if(!(b==this.view.x&&a==this.view.y)){this.checkBounds(b,a);this.canvas.setStyles({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2)});this.requestImages();
this.positionZone()}},nudge:function(b,a){this.checkBounds(this.view.x+b,this.view.y+a);this.canvas.morph({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2)});this.positionZone()},zoom:function(b){b=new DOMEvent(b);b.stop();var a=1;a=b.wheel&&b.wheel<0?-1:b.shift?-1:1;var c=b.target;if(c){c=c.get("class");if(c!="zone"&c!="navimage"){c=this.canvas.getPosition();this.view.x=b.event.clientX-c.x-this.view.w/
2;this.view.y=b.event.clientY-c.y-this.view.h/2}else{c=this.zone.getParent().getPosition();var d=this.zone.getParent().getSize(),e=this.zone.getSize();this.view.x=(b.event.clientX-c.x-e.x/2)*this.wid/d.x;this.view.y=(b.event.clientY-c.y-e.y/2)*this.hei/d.y}if(IIPMooViewer.sync){var f=this.view.x,g=this.view.y;IIPMooViewer.windows(this).each(function(h){h.view.x=f;h.view.y=g})}}a==-1?this.zoomOut():this.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(this).each(function(h){a==-1?h.zoomOut():h.zoomIn()})},
zoomIn:function(){if(this.view.res<this.num_resolutions-1){this.view.res++;this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;this.view.x=Math.round(2*(this.view.x+(this.resolutions[this.view.res-1].w>this.view.w?this.view.w:this.resolutions[this.view.res-1].w)/4));if(this.view.x>this.wid-this.view.w)this.view.x=this.wid-this.view.w;if(this.view.x<0)this.view.x=0;this.view.y=Math.round(2*(this.view.y+this.view.h/4));if(this.view.y>this.hei-this.view.h)this.view.y=
this.hei-this.view.h;if(this.view.y<0)this.view.y=0;this.canvas.setStyles({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2),width:this.wid,height:this.hei});if(this.wid<this.view.w||this.hei<this.view.h)this.reCenter();else this.touch.options.limit={x:[this.view.w-this.wid,0],y:[this.view.h-this.hei,0]};this.canvas.getChildren("img").destroy();this.tiles.empty();this.requestImages();this.positionZone();
this.scale&&this.updateScale()}},zoomOut:function(){if(this.view.res>0){this.view.res--;this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;this.view.x=this.view.x/2-this.view.w/4;if(this.view.x+this.view.w>this.wid)this.view.x=this.wid-this.view.w;this.view.y=this.view.y/2-this.view.h/4;if(this.view.y+this.view.h>this.hei)this.view.y=this.hei-this.view.h;var b=this.wid>this.view.w?this.view.x:(this.wid-this.view.w)/2,a=this.hei>this.view.h?this.view.y:(this.hei-
this.view.h)/2;if(this.view.x<0)this.view.x=0;if(this.view.y<0)this.view.y=0;if(b<0)b=0;if(a<0)a=0;this.canvas.setStyles({left:-b,top:-a,width:this.wid,height:this.hei});if(this.wid<this.view.w||this.hei<this.view.h)this.reCenter();else this.touch.options.limit={x:[this.view.w-this.wid,0],y:[this.view.h-this.hei,0]};this.canvas.getChildren("img").destroy();this.tiles.empty();this.requestImages();this.positionZone();this.scale&&this.updateScale()}},calculateSizes:function(){var b=this.max_size.w,a=
this.max_size.h,c;c=document.id(this.source).getSize();this.view.w=c.x;this.view.h=c.y;c=this.view.w*this.navWinSize;if(b>2*a)c=this.view.w/2;this.navWin.w=c;this.navWin.h=Math.round(a/b*c);this.view.res=this.num_resolutions;b=this.max_size.w;a=this.max_size.h;this.resolutions=Array(this.num_resolutions);this.resolutions.push({w:b,h:a});this.view.res=0;for(c=1;c<this.num_resolutions;c++){b=Math.floor(b/2);a=Math.floor(a/2);this.resolutions.push({w:b,h:a});b<this.view.w&&a<this.view.h&&this.view.res++}this.view.res-=
1;if(this.view.res<0)this.view.res=0;if(this.view.res>=this.num_resolutions)this.view.res=this.num_resolutions-1;this.resolutions.reverse();this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h},setCredit:function(b){document.id(this.source).getElement("div.credit").set("html",b)},createWindows:function(){var b=document.id(this.source);b.getPosition();if(b.getStyle("width")=="100%"&&b.getStyle("height")=="100%")this.enableFullscreen=false;b.getSize();b.addClass("iipmooviewer");
b.setStyle("position","absolute");(new Element("div",{"class":"info",styles:{opacity:0},events:{click:function(){this.fade("out")}},html:'<div><div><h2><a href="http://iipimage.sourceforge.net"><img src="'+this.prefix+'iip.32x32.png"/></a>IIPMooViewer</h2>IIPImage HTML5 Ajax High Resolution Image Viewer - Version '+this.version+"<br/><ul><li>"+IIPMooViewer.lang.navigate+"</li><li>"+IIPMooViewer.lang.zoomIn+"</li><li>"+IIPMooViewer.lang.zoomOut+"</li><li>"+IIPMooViewer.lang.rotate+"</li><li>"+IIPMooViewer.lang.resize+
"<li>"+IIPMooViewer.lang.annotations+"</li><li>"+IIPMooViewer.lang.navigation+"</li></ul><br/>"+IIPMooViewer.lang.more+' <a href="http://iipimage.sourceforge.net">http://iipimage.sourceforge.net</a></div></div>'})).inject(b);var a=this;this.canvas=new Element("div",{"class":"canvas",morph:{transition:Fx.Transitions.Quad.easeInOut,onComplete:function(){a.requestImages()}}});this.touch=new Drag(this.canvas,{onComplete:this.scroll.bind(this)});this.canvas.inject(b);this.canvas.addEvents({"mousewheel:throttle(75)":this.zoom.bind(this),
dblclick:this.zoom.bind(this),mousedown:function(d){(new DOMEvent(d)).stop()}});if(this.annotations){this.canvas.addEvent("mouseenter",function(){a.annotationsVisible&&a.canvas.getElements("div.annotation").removeClass("hidden")});this.canvas.addEvent("mouseleave",function(){a.annotationsVisible&&a.canvas.getElements("div.annotation").addClass("hidden")})}this.disableContextMenu&&b.addEvent("contextmenu",function(d){(new DOMEvent(d)).stop();b.getElement("div.info").fade(0.95);return false});this.targetclick&&
this.canvas.addEvent("click",this.targetclick.bind(this));b.set("tabindex",0);b.focus();b.addEvents({keydown:this.key.bind(this),mouseover:function(){b.focus()},mouseout:function(){b.blur()},mousewheel:function(d){d.preventDefault()}});if(Browser.Platform.ios||Browser.Platform.android){this.preload=true;b.addEvent("touchmove",function(d){d.preventDefault()});document.body.addEvents({touchmove:function(d){d.preventDefault()},orientationchange:function(){document.id(this.source).setStyles({width:"100%",
height:"100%"});this.reload.delay(500,this)}.bind(this)});this.canvas.addEvents({touchstart:function(d){d.preventDefault();if(d.touches.length==1){var e=a.canvas.retrieve("taptime")||0,f=Date.now();a.canvas.store("taptime",f);a.canvas.store("tapstart",1);if(f-e<500){a.canvas.eliminate("taptime");a.zoomIn()}else{e=a.canvas.getPosition();a.touchstart={x:d.touches[0].clientX-e.x,y:d.touches[0].clientY-e.y}}}},touchmove:function(d){if(d.touches.length==1){a.view.x=a.touchstart.x-d.touches[0].clientX;
a.view.y=a.touchstart.y-d.touches[0].clientY;if(a.view.x>a.wid-a.view.w)a.view.x=a.wid-a.view.w;if(a.view.y>a.hei-a.view.h)a.view.y=a.hei-a.view.h;if(a.view.x<0)a.view.x=0;if(a.view.y<0)a.view.y=0;a.canvas.setStyles({left:a.wid>a.view.w?-a.view.x:Math.round((a.view.w-a.wid)/2),top:a.hei>a.view.h?-a.view.y:Math.round((a.view.h-a.hei)/2)})}},touchend:function(){if(a.canvas.retrieve("tapstart")==1){a.canvas.eliminate("tapstart");a.requestImages();a.positionZone()}},gesturestart:function(d){d.preventDefault();
a.canvas.store("tapstart",1)},gesturechange:function(d){d.preventDefault()},gestureend:function(d){if(a.canvas.retrieve("tapstart")==1){a.canvas.eliminate("tapstart");if(Math.abs(1-d.scale)>0.1)d.scale>1?a.zoomIn():a.zoomOut();else if(Math.abs(d.rotation)>10){if(d.rotation>0)a.view.orientation+=45;else a.view.orientation-=45;a.rotate(a.view.orientation)}}}})}var c=(new Element("img",{src:this.prefix+"iip.32x32.png","class":"logo",title:IIPMooViewer.lang.help,events:{click:function(){b.getElement("div.info").fade(0.95)},
mousedown:function(d){(new DOMEvent(d)).stop()}}})).inject(b);Browser.Platform.ios&&window.navigator.standalone&&c.setStyle("top",15);this.credit&&(new Element("div",{"class":"credit",html:this.credit,events:{mouseover:function(){this.fade([0.6,0.9])},mouseout:function(){this.fade(0.6)}}})).inject(b);if(this.scale){c=(new Element("div",{"class":"scale",title:IIPMooViewer.lang.scale,html:'<div class="ruler"></div><div class="label"></div>'})).inject(b);c.makeDraggable({container:b});c.getElement("div.ruler").set("tween",
{transition:Fx.Transitions.Quad.easeInOut})}this.calculateSizes();this.createNavigationWindow();this.createAnnotations();if(!(Browser.Platform.ios||Browser.Platform.android)){c="img.logo, div.toolbar, div.scale";if(Browser.ie8||Browser.ie7)c="img.logo, div.toolbar";new Tips(c,{className:"tip",onShow:function(d){d.setStyles({opacity:0}).fade(0.9)},onHide:function(d){d.fade(0).get("tween").chain(function(){})}})}if(this.viewport&&this.viewport.resolution!=null){this.view.res=this.viewport.resolution;
this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;this.touch.options.limit={x:[this.view.w-this.wid,0],y:[this.view.h-this.hei,0]}}this.viewport&&this.viewport.x!=null&&this.viewport.y!=null?this.moveTo(this.viewport.x*this.wid,this.viewport.y*this.hei):this.reCenter();this.canvas.setStyles({width:this.wid,height:this.hei});this.requestImages();this.positionZone();this.scale&&this.updateScale();this.winResize&&window.addEvent("resize",this.reload.bind(this));window.fireEvent("iiploaded")},
createNavigationWindow:function(){if(this.showNavWindow||this.showNavButtons){var b=new Element("div",{"class":"navcontainer",styles:{position:"absolute",width:this.navWin.w}});Browser.Platform.ios&&window.navigator.standalone&&b.setStyle("top",20);var a=new Element("div",{"class":"toolbar",events:{dblclick:function(f){document.id(f).getElement("div.navbuttons").get("slide").toggle()}.pass(this.source)}});a.store("tip:text",IIPMooViewer.lang.drag);a.inject(b);if(this.showNavWindow){var c=new Element("div",
{"class":"navwin",styles:{height:this.navWin.h}});c.inject(b);(new Element("img",{"class":"navimage",src:this.server+"?FIF="+this.images[0].src+"&SDS="+this.images[0].sds+"&WID="+this.navWin.w+"&QLT=99&CVT=jpeg",events:{click:this.scrollNavigation.bind(this),"mousewheel:throttle(75)":this.zoom.bind(this),mousedown:function(f){(new DOMEvent(f)).stop()}}})).inject(c);this.zone=new Element("div",{"class":"zone",morph:{duration:500,transition:Fx.Transitions.Quad.easeInOut},events:{"mousewheel:throttle(75)":this.zoom.bind(this),
dblclick:this.zoom.bind(this)}});this.zone.inject(c)}if(this.showNavButtons){var d=new Element("div",{"class":"navbuttons"}),e=this.prefix;["reset","zoomIn","zoomOut"].each(function(f){(new Element("img",{src:e+f+".svg","class":f,events:{error:function(){this.removeEvents("error");this.src=this.src.replace(".svg",".png")}}})).inject(d)});d.inject(b);d.set("slide",{duration:300,transition:Fx.Transitions.Quad.easeInOut,mode:"vertical"});d.getElement("img.zoomIn").addEvent("click",function(){IIPMooViewer.windows(this).each(function(f){f.zoomIn()});
this.zoomIn()}.bind(this));d.getElement("img.zoomOut").addEvent("click",function(){IIPMooViewer.windows(this).each(function(f){f.zoomOut()});this.zoomOut()}.bind(this));d.getElement("img.reset").addEvent("click",function(){IIPMooViewer.windows(this).each(function(f){f.reload()});this.reload()}.bind(this))}this.showNavWindow&&(new Element("div",{"class":"loadBarContainer",html:'<div class="loadBar"></div>',styles:{width:this.navWin.w-2},tween:{duration:1E3,transition:Fx.Transitions.Sine.easeOut,link:"cancel"}})).inject(b);
b.inject(this.source);this.showNavWindow&&this.zone.makeDraggable({container:document.id(this.source).getElement("div.navcontainer div.navwin"),onStart:function(){var f=this.zone.getPosition();this.navpos={x:f.x,y:f.y-10}}.bind(this),onComplete:this.scrollNavigation.bind(this)});b.makeDraggable({container:this.source,handle:a})}},createAnnotations:function(){if(this.annotations){this.annotations.sort(function(d,e){return e.w*e.h-d.w*d.h});for(var b=0;b<this.annotations.length;b++)if(this.wid*(this.annotations[b].x+
this.annotations[b].w)>this.view.x&&this.wid*this.annotations[b].x<this.view.x+this.view.w&&this.hei*(this.annotations[b].y+this.annotations[b].h)>this.view.y&&this.hei*this.annotations[b].y<this.view.y+this.view.h){var a=(new Element("div",{"class":"annotation",styles:{left:Math.round(this.wid*this.annotations[b].x),top:Math.round(this.hei*this.annotations[b].y),width:Math.round(this.wid*this.annotations[b].w),height:Math.round(this.hei*this.annotations[b].h)}})).inject(this.canvas);this.annotationsVisible==
false&&a.addClass("hidden");var c=this.annotations[b].text;if(this.annotations[b].title)c="<h1>"+this.annotations[b].title+"</h1>"+c;a.store("tip:text",c)}if(!this.annotationTip)this.annotationTip=new Tips("div.annotation",{className:"tip",fixed:true,offset:{x:30,y:30},hideDelay:300,link:"chain",onShow:function(){this.tip.setStyle("display","block").fade(0.9);this.tip.addEvents({mouseleave:function(){this.active=false;this.fade("out").get("tween").chain(function(){this.element.setStyle("display",
"none")})},mouseenter:function(){this.active=true}})},onHide:function(){if(!this.tip.active){this.tip.fade("out").get("tween").chain(function(){this.element.setStyle("display","none")});this.tip.removeEvents(["mouseenter","mouseleave"])}}})}},toggleAnnotations:function(){var b;if(b=this.canvas.getElements("div.annotation"))if(this.annotationsVisible){b.addClass("hidden");this.annotationsVisible=false;this.showPopUp(IIPMooViewer.lang.annotationsDisabled)}else{b.removeClass("hidden");this.annotationsVisible=
true}},refreshLoadBar:function(){var b=this.nTilesLoaded/this.nTilesToLoad*this.navWin.w,a=document.id(this.source).getElement("div.navcontainer div.loadBarContainer"),c=a.getElement("div.loadBar");c.setStyle("width",b);c.set("html",IIPMooViewer.lang.loading+"&nbsp;:&nbsp;"+Math.round(this.nTilesLoaded/this.nTilesToLoad*100)+"%");a.style.opacity!=0.85&&a.setStyle("opacity",0.85);this.nTilesLoaded>=this.nTilesToLoad&&a.fade("out")},updateScale:function(){var b=[1.0E-12,1.0E-9,1.0E-6,0.0010,0.01,1,
1E3],a=[1,2,5,10,50],c=1E3*this.scale*this.wid/this.max_size.w,d,e;d=0;a:for(;d<b.length;d++)for(e=0;e<a.length;e++)if(b[d]*a[e]*c>this.view.w/20)break a;if(d>=b.length)d=b.length-1;if(e>=a.length)e=a.length-1;var f=a[e]+["p","n","&#181;","m","c","","k"][d]+"m";c=c*b[d]*a[e];document.id(this.source).getElement("div.scale div.ruler").tween("width",c);document.id(this.source).getElement("div.scale div.label").set("html",f)},load:function(){if(this.loadoptions){this.max_size=this.loadoptions.size;this.tileSize=
this.loadoptions.tiles;this.num_resolutions=this.loadoptions.resolutions;this.createWindows()}else(new Request({method:"get",url:this.server,onComplete:function(b){b=this.protocol.parseMetaData(b||alert("Error: No response from server "+this.server));this.max_size=b.max_size;this.tileSize=b.tileSize;this.num_resolutions=b.num_resolutions;this.createWindows()}.bind(this),onFailure:function(){alert("Error: Unable to get image metadata from server!")}})).send(this.protocol.getMetaDataURL(this.images[0].src))},
reload:function(){this.canvas.get("morph").cancel();this.canvas.getChildren("img").destroy();this.tiles.empty();this.calculateSizes();document.id(this.source).getElements("div.navcontainer, div.navcontainer div.loadBarContainer").setStyle("width",this.navWin.w);if(this.showNavWindow){var b=document.id(this.source).getElement("div.navcontainer");if(b)b.setStyles({top:Browser.Platform.ios&&window.navigator.standalone?20:10,left:document.id(this.source).getPosition(this.source).x+document.id(this.source).getSize().x-
b.getSize().x-10});this.zone&&this.zone.getParent().setStyles({height:this.navWin.h})}if(this.scale){this.updateScale();pos=document.id(this.source).getSize().y-document.id(this.source).getElement("div.scale").getSize().y-10;document.id(this.source).getElement("div.scale").setStyles({left:10,top:pos})}b=this.CSSprefix+"transform-origin";var a=this.CSSprefix+"transform";this.canvas.setStyles({width:this.wid,height:this.hei});this.canvas.setStyle(b,"50% 50%");this.canvas.setStyle(a,"rotate(0deg)");
this.zone&&this.zone.setStyle(a,"rotate(0deg)");this.view.orientation=0;this.reCenter();this.requestImages();this.positionZone()},reCenter:function(){var b=Math.round((this.wid-this.view.w)/2);this.view.x=b<0?0:b;b=Math.round((this.hei-this.view.h)/2);this.view.y=b<0?0:b;this.canvas.setStyles({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2)});this.touch.options.limit={x:this.wid<this.view.w?[Math.round((this.view.w-
this.wid)/2),Math.round((this.view.w-this.wid)/2)]:[this.view.w-this.wid,0],y:this.hei<this.view.h?[Math.round((this.view.h-this.hei)/2),Math.round((this.view.h-this.hei)/2)]:[this.view.h-this.hei,0]}},positionZone:function(){if(this.showNavWindow){var b=this.view.x/this.wid*this.navWin.w;if(b>this.navWin.w)b=this.navWin.w;if(b<0)b=0;var a=this.view.y/this.hei*this.navWin.h;if(a>this.navWin.h)a=this.navWin.h;if(a<0)a=0;var c=this.view.w/this.wid*this.navWin.w;if(b+c>this.navWin.w)c=this.navWin.w-
b;var d=this.view.h/this.hei*this.navWin.h;if(d+a>this.navWin.h)d=this.navWin.h-a;var e=this.zone.offsetHeight-this.zone.clientHeight;this.zone.morph({left:b,top:a+8,width:c-e>0?c-e:1,height:d-e>0?d-e:1})}}});IIPMooViewer.synchronize=function(b){this.sync=b};IIPMooViewer.windows=function(b){if(!this.sync)return[];return this.sync.filter(function(a){return a!=b})};Browser.buggy=Browser.ie&&Browser.version<9?true:false;IIPMooViewer.lang={help:"click for help",scale:"draggable scale",navigate:"To navigate within image: drag image within main window or drag zone within the navigation window or click an are a within navigation window",zoomIn:'To zoom in: double click with the mouse or use the mouse scroll wheel or simply press the "+" key',zoomOut:'To zoom out: shift double click with the mouse or use the mouse wheel or press the "-" key',rotate:'To rotate image clockwise: press the "r" key, anti-clockwise: press shift and "r"',
resize:'To resize to fill page: press the "f" key',annotations:'To toggle any annotations: press the "a" key',navigation:'To show/hide navigation window: press "h" key',more:"For more information visit",fullscreen:"Press Esc to exit full page mode.<br/>Press F11 for full screen",loading:"loading",drag:"* Drag to move<br/>* Double Click to show/hide buttons<br/>* Press h to hide",annotationsDisabled:'Annotations disabled<br/>Press "a" to re-enable'};
